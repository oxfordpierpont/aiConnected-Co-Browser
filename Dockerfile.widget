# Widget Builder Dockerfile
# Builds the production widget bundle

FROM node:20-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Build widget with environment variables
ARG API_BASE_URL=https://api.siteguide.io
ARG WS_URL=wss://api.siteguide.io/ws

ENV API_BASE_URL=$API_BASE_URL
ENV WS_URL=$WS_URL

RUN npm run build:widget

# Output stage - just copy the built files
FROM alpine:latest

WORKDIR /app

COPY --from=builder /app/dist/widget /app/dist/widget

# Keep container running briefly to allow volume copy
CMD ["sh", "-c", "cp -r /app/dist/widget/* /app/dist/widget/ 2>/dev/null || true && echo 'Widget built successfully' && sleep 5"]
